---
title: "fed_pool3"
author: "Luis Luarte"
date: '2022-09-30'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libs

```{r}
pacman::p_load(
  tidyverse,
  ggplot2,
  ggpubr,
  lme4,
  lmerTest
)
```

# Helper functions
```{r}

```

# Import data

```{r}
# weights
weight_data <- read_csv("https://raw.githubusercontent.com/nicolasluarte/PHD_data/main/objective_1/data/raw/weights/weights_pool3.csv") %>% 
  mutate(
    ID = as.factor(ID),
    date = lubridate::ymd(date),
    weight = as.numeric(weight),
    exp_group = if_else(ID %in% c(416, 413, 418, 417, 419), "uncertainty", "control")
  )

# fed data
intake_files <- list.files(path = "~/repos/nbolab_FED/raw_data/",
                          pattern = "^4",
                          recursive = TRUE,
                          full.names = TRUE)
intake_data <- read_csv(intake_files) %>% 
  mutate(
    time = lubridate::as_datetime(time),
    date = lubridate::date(time),
    animal = as.factor(animal),
    delay = as.numeric(delay)
  ) %>% 
  filter(time >= "2022-09-26 00:00:00") %>% 
  rename(ID = animal) %>%
  mutate(
    exp_group = if_else(ID %in% c(416, 413, 418, 417, 419), "uncertainty", "control")
  ) %>% 
  group_by(ID) %>% 
  group_nest(., keep = TRUE, .key = "intake_raw")
```


# preliminar plots
```{r}
# daily intake
intake_daily <- intake_data %>% 
  unnest() %>% 
  filter(date < "2022-10-14") %>% 
  group_by(date, exp_group, ID) %>% 
  summarise(
    m = n()
  ) %>% 
  ungroup() %>% 
  group_by(ID) %>% 
  mutate(
    mean_intake = as.integer(mean(m)),
    m = if_else(m < 10, mean_intake, m),
    exp_phase = if_else(date >= "2022-10-04", "experimental", "baseline")
    )
  
  
# daily intake plot
intake_daily %>% 
  ggplot(aes(
    date, m, color = interaction(exp_group), group = interaction(exp_group, ID)
  )) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.3) +
  geom_vline(xintercept = as.Date("2022-10-04")) +
  stat_summary(aes(group=exp_group, color = exp_group), fun=mean, geom="line", size = 0.7) +
  stat_summary(aes(group=exp_group, color = exp_group), fun.data = mean_se, geom = "errorbar", size = 0.7) +
  scale_y_continuous(breaks = seq(20, 100, 10)) +
  theme_pubr()

# weigh plot
weight_data %>% 
  ggplot(aes(
    date, weight, group = interaction(exp_group, ID), color = exp_group
  )) +
  geom_line(alpha = 0.3) +
  geom_point(alpha = 0.3) +
  geom_vline(xintercept = as.Date("2022-10-04")) +
  stat_summary(aes(group=exp_group, color = exp_group), fun=mean, geom="line", size = 0.7) +
  stat_summary(aes(group=exp_group, color = exp_group), fun.data = mean_se, geom = "errorbar", size = 0.7) +
  theme_pubr()

summary(
  lmer(m ~ exp_group + (1 | ID), data = intake_daily %>%  filter(exp_phase == "experimental"))
)
```


