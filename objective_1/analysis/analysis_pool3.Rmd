---
title: "fed_pool3"
author: "Luis Luarte"
date: '2022-09-30'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libs

```{r}
pacman::p_load(
  tidyverse,
  ggplot2,
  ggpubr
)
```

# Helper functions
```{r}

```

# Import data

```{r}
# weights
weight_data <- read_csv("https://raw.githubusercontent.com/nicolasluarte/PHD_data/main/objective_1/data/raw/weights/weights_pool3.csv") %>% 
  mutate(
    ID = as.factor(ID),
    date = lubridate::ymd(date),
    weight = as.numeric(weight)
  )

# fed data
intake_files <- list.files(path = "~/repos/nbolab_FED/raw_data/",
                          pattern = "^4",
                          recursive = TRUE,
                          full.names = TRUE)
intake_data <- read_csv(intake_files) %>% 
  mutate(
    time = lubridate::as_datetime(time),
    date = lubridate::date(time),
    animal = as.factor(animal),
    delay = as.numeric(delay)
  ) %>% 
  filter(time >= "2022-09-26 00:00:00") %>% 
  rename(ID = animal) %>%
  group_by(ID) %>% 
  group_nest(., keep = TRUE, .key = "intake_raw")
```

# Intake data analysis

```{r}
intake_data <- intake_data %>% 
  mutate(
    # add daily intake summary data
    daily_intake = map(intake_raw, function(df){
      df %>% 
        group_by(date, ID) %>% 
        summarise(
          pellets = n()
        ) %>% 
        ungroup()
    }),
    # add hourly intake summary data
    hourly_intake = map(intake_raw, function(df){
      df %>% 
        group_by(lubridate::hour(time), ID) %>% 
        summarise(
          pellets = n()
        ) %>% 
        ungroup()
    }),
    # add intake lag
    intake_lag = map(intake_raw, function(df){
      df %>% 
      group_by(date, ID) %>% 
        mutate(
          intake_lag = replace_na(as.numeric(time - lag(time)), 0) - delay
        ) %>% 
        ungroup()
    })
  )
```

# weight data analysis
```{r}
weight_data_m <- weight_data %>% 
  group_by(date) %>% 
  summarise(
    weight_ = mean(weight),
    e = sd(weight) / sqrt(n())
  ) %>% 
  rename(weight = weight_) %>% 
  mutate(ID = "Mean weight")
```

# Data merge

```{r}
# daily intake data
intake_data_daily <- intake_data$daily_intake %>% bind_rows() %>% 
  mutate(exp_group = if_else(ID %in% c(416, 413, 418, 417, 419), "uncertainty", "control"))
# daily intake data means
intake_data_m <- intake_data_daily %>% 
  ungroup() %>% 
  group_by(date) %>% 
  summarise(
    pellets_ = mean(pellets),
    e = sd(pellets) / sqrt(n())
  ) %>% 
  rename(pellets = pellets_)
weight_intake <- intake_data_daily %>% 
  complete(., date, ID, fill = list(pellets = 1)) %>% 
  left_join(weight_data, by = c("date", "ID")) %>% 
  group_by(ID) %>% 
  mutate(
    weight_intrp = zoo::na.approx(weight, na.rm = FALSE)
  )

pellets_gr <- weight_intake %>% 
  mutate(pellets_gr = pellets / weight_intrp)
```

# group assig

```{r}
intake_m <- intake_data_daily %>% 
  group_by(ID) %>% 
  summarise(i = mean(pellets))
weight_m <- weight_data %>% 
  group_by(ID) %>% 
  summarise(w = mean(weight))
assig <- left_join(intake_m, weight_m) %>% 
  arrange(desc(i))
trt <- c(416, 413, 418, 417, 419)
assig <- assig %>% 
  mutate(exp_group = if_else(ID %in% trt, "experimental", "control")) %>% 
  arrange(ID)
# test for diffs
# intake
summary(lm(data = assig, i ~ exp_group))
# weight
summary(lm(data = assig, w ~ exp_group))
```

# Plots

```{r}
# weight plot

weight_data %>% 
  ggplot(aes(
    date,
    weight,
    color = ID
  )) +
  geom_line() +
  geom_point() +
  geom_line(data = weight_data_m, color = "black") +
  geom_point(data = weight_data_m, color = "black") +
  geom_errorbar(data = weight_data_m,
                aes(ymin = weight - e, ymax = weight + e),
                color = "black") +
  geom_vline(xintercept = as.numeric(as.Date("2022-09-26"))) +
  theme_pubr()

# intake plot

intake_data_daily %>% 
  filter(date < "2022-10-07", pellets != 1) %>% 
  ggplot(aes(date, pellets, color = interaction(ID, exp_group))) +
  geom_line() +
  geom_point() +
  geom_line(
    data = intake_data_m %>% filter(date < "2022-10-07"),
    color = "black"
  ) +
  geom_errorbar(
    data = intake_data_m %>% filter(date < "2022-10-07"),
    color = "black",
    aes(ymin = pellets - e, ymax = pellets + e)
  ) +
  geom_point(
    data = intake_data_m %>% filter(date < "2022-10-07"),
    color = "black"
  ) +
  geom_vline(xintercept = as.numeric(as.Date("2022-10-04"))) +
  facet_wrap(~exp_group) +
  theme_pubr()
```

